<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <title>Ecological Modelling Laboratory</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="description" content=""/>
    <link rel="icon" href="media/squirrel-32x32.ico">
    <link rel="stylesheet" type="text/css" href="basic.css"/>
    <link rel="stylesheet" type="text/css" href="my-flex.css"/>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  </head>
  <body>
  <div class="insert macro">#header.html#models#Let's sharpen the questions</div>
  <div class="begin macro"></div>
    <div id="header" class="border-blue">
      <div id="title">
        <img src="media/squirrel.gif"/>
        <div>
          <h1 id="top">Ecological Modelling Laboratory</h1>
          <p class="slogan">Let's sharpen the questions</p>
        </div>
      </div>
      <nav>
        <a href="index.html" id="home">Home</a>
        <a href="intro.html" id="intro">Intro</a>
        <a href="commands.html" id="commands">Commands</a>
        <a href="boxscript.html" id="boxscript">BoxScript</a>
        <a href="models.html" id="current">Models</a>
        <a href="download.html" id="download">Download</a>
        <a href="about.html" id="about">About</a>
      </nav>
    </div>
  <div class="end macro"></div>
    <div class="wide-panel">
      
      <div class="begin-index-headers"></div>
      <div class="central">

<p class='hidden-anchor' id='overview'>xxx</p><div class='border-grey'>
<h1>Overview</h1>
<p>Many models have been implemented in Universal Simulator. Most have been published while others are still in development. Here you will find documentation for all these models. Well, at some time in the future you will. Currently, the existing documentation of models is being re-formated for this web page. The list of models found here will grow with time. The <em>Saccharina</em> and <em>Virtual Greenhouse</em> models will have been added by early September 2023.</p>
</div>


<p class='hidden-anchor' id='cereal-aphid-fungus-model'>xxx</p><div class='border-grey'>
<h1>Cereal aphid-fungus model</h1>
<p>Many models have been implemented in Universal Simulator. Most have been published while others are still in development. Here you will find documentation for all these models. Well, at some time in the future you will. Currently, the existing documentation of models is being re-formated for this web page. The list of models found here will grow with time. The <em>Saccharina</em> and <em>Virtual Greenhouse</em> models will have been added by early September 2023.</p>
</div>

<p class='hidden-anchor' id='background'>xxx</p><div class='border-grey'>
<h2>Background</h2>
<p>This is a tri-trophic model of the winter wheat-cereal aphid (<em>Sitobion avenae</em>)-fungus (<em>Pandora neoaphidis</em>) system, simulating the dynamics of aphid and fungus from spring until harvest. The winter wheat model is rudimentary; the crop is only represented as a growth stage modelled by a regression model fitted to Norwegian growing conditions. Weather data (daily average temperature and maximum relative humidity) drives the model. Optionally, the winter wheat model can be left out, and the crop growth stage instead supplied as an additional column in the weather file. A scientific paper (St√©phanie Saussure et al.) presenting the model is currently (2022) under review.</p>
<p>Below you will find models of increasing complexity, building up to the full model found in the scientific paper. The models are composed of building blocks, implemented as C++ <a href='#'>classes</a>. The functionality of model building blocks were implemented in C++. If you really want to get the depth of that, you can download the <a href='https://www.ecolmod.org/download/#source-code'>source code</a>. The classes specific to this model is found in the <code>src/plugins/aphid</code> source code folder.</p>
<p>Each model building block was designed to solve a particular task. The model was constructed from building blocks included in the standard plugin (<a href='#'>boxes</a>), together with building blocks developed specifically for this model (in the <a href='#'>aphid</a> plugin). </p>
<p>You can run the boxscripts shown in the sub-sections below yourself. For that purpose you must <a href='#'>install Universal Simulator</a>. For example, to run the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/crop-aphid-model.box">crop-aphid-model.box&cudarrr;</a> script, you write at the Universal Simulator prompt:</p>
<pre><code class="command">> run models/aphid/crop-aphid-model.box
</code></pre>
<p>Paste the clipboard at the R prompt to see the output as described in <a href='#'>Running simulations</a>.</p>
</div>        
        
<p class='hidden-anchor' id='weather-driven'>xxx</p><p class='hidden-anchor' id='crop-model'>xxx</p><div class='border-grey'>
<h2>Crop model</h2>
<p>The crop model can either be weather-driven (by a weather file) or data-driven (by recorded wheat growth stages).</p>
<h3><li>Weather-driven</li></h3>
<p>The weather-driven crop model makes use of the <a href='#'>CropGrowthStage</a> and <a href='#'>CropIsGrowing</a> models, tailored for Norwegian conditions, together with the generic <a href='#'>DayDegrees</a> model. A <a href='#'>Calendar</a> and <a href='#'>Records</a> box provides the driving data:</p>
<pre><code><a href="https://tildeweb.au.dk/au152367/input/models/aphid/crop-model-weather-driven.box.box">// crop-model-weather-driven.box&cudarrr;</a>
Simulation sim {
  Calendar calendar {
    .begin = 01/04/2004
    .end   = 31/08/2004
  }
  Records weather {
    .fileName =  &quot;weather/Aarnes_2004.txt&quot;
  } 
  CropGrowthStage cropGrowthStage {
    .valueAtStart       = 20.0
    .dayDegreesHalfways = 800.0
    .slope              = 2.8
    .dayDegrees = ./time[total]
    CropIsGrowing isGrowing {
      .temperature = weather[Tavg] 
    }
    DayDegrees time{
      .T = weather[Tavg]
      .T0 = 0
      .isTicking = ../isGrowing[value]
    }
  }
  OutputR {
    PageR {
      .xAxis = calendar[date]
      .width = 6
      .height = 3.5
      PlotR {
        .ports = cropGrowthStage[value]
      }
    }
  }
}
</code></pre>
<p>Run the model from the Universal Simulator prompt with</p>
<pre><code class="command">> run models/aphid/crop-model-weather-driven.box
</code></pre>
<p>and paste to R to see the output:</p>
<img src="https://tildeweb.au.dk/au152367//media/models/aphid/aphid-crop-model-weather-driven.png" style="zoom:80%;" />
<p>&nbsp;</p>
<h3 id='optionally-data-driven'><li>Optionally data-driven</li></h3>
<p>The crop sub-model used in the final, complete model is flexible. It will pick the growth stage from the weather file, if a <code>CropGrowthStage</code> column is available. Otherwise, it uses the value provided by the weather-driven model. This feature was needed for the validation runs of the model, because the field observations were not from Norway. In those cases, the <code>CropGrowthStage</code> model cannot be expected to hold; it is more accurate to use the observed crop growth stages. Here is the boxscript to demonstrate a data-driven crop growth stage:</p>
<pre><code><a href="https://tildeweb.au.dk/au152367/input/models/aphid/crop-model-data-driven.box">// crop-model-data-driven.box&cudarrr;</a>
Simulation sim {
  Calendar calendar {
    .begin = 01/04/1995
    .end   = 31/08/1995
  }
  Records weather {
    .fileName = &quot;validation/A95-weather-gs.txt&quot;
  } 
  Box wheat{
    CropGrowthStage cropGrowthStageModel {
      .valueAtStart       = 20.0
      .dayDegreesHalfways = 800.0
      .slope              = 2.8
      .dayDegrees = ./time[total]
      CropIsGrowing isGrowing {
        .temperature = weather[Tavg] 
      }
      DayDegrees time{
        .T = weather[Tavg]
        .T0 = 0
        .isTicking = ../isGrowing[value]
      }
    }
    Box cropGrowthStage {
      // Pick growth stage either from the weather file 
         or else from the growth stage model
      &amp;value = if exists(weather[GrowthStage]) then weather[GrowthStage] 
                   else ../cropGrowthStageModel[value]
    }
  }
  OutputR {
    PageR {
      .xAxis = calendar[date]
      .width = 6
      .height = 3.5
      PlotR {
        .ports = cropGrowthStage[value]
      }
    }
  }
}
</code></pre>
<p>Run the model from the Universal  Simulator prompt with</p>
<pre><code class="command">> run models/aphid/crop-model-data-driven.box
</code></pre>
<p>and paste to R to see the output:</p>
<p><img src="https://tildeweb.au.dk/au152367//media/models/aphid/aphid-crop-model-data-driven.png" style="zoom:80%;" /></p>
</div>

<p class='hidden-anchor' id='crop-aphid-model'>xxx</p><div class='border-grey'>
<h2>Crop-aphid model</h2>
<p>In this model, the fungus is left out, so it is basically a model of aphid population dynamics driven bottom-up by the crop. The model is composed of these dedicated model building blocks, which is worth to look up. They each solve one particular task specific to this model:</p>
<ul>
<li><a href='#'>CropGrowthStage</a></li>
<li><a href='#'>CropIsGrowing</a></li>
<li><a href='#'>AphidImmigration</a></li>
<li><a href='#'>AphidNetReproduction</a></li>
<li><a href='#'>AphidOffspring</a></li>
<li><a href='#'>AphidJuvenileSurvival</a></li>

</ul>
<p>In addition, you will find these basic building blocks:</p>
<ul>
<li><a href='#'>Calendar</a></li>
<li><a href='#'>Records</a></li>
<li><a href='#'>Stage</a></li>

</ul>
<p>After you have loaded the model:</p>
<pre><code class="command">> load models/aphid/crop-aphid-model.box
</code></pre>
<p>The <code class="command">list</code> command will show you the model structure:</p>
<pre><code class="command">> list</code>
<code class="output">Simulation sim
  Box param
  Calendar calendar
  Records weather
  Box wheat
    CropGrowthStage cropGrowthStageModel
      CropIsGrowing isGrowing
      DayDegrees time
    Box cropGrowthStage
  Box aphid
    DayDegrees time
    Box density
    AphidImmigration immigration
    AphidNetReproduction netReproduction
    AphidOffspring offspring
    AphidJuvenileSurvival survival
    Box susceptible
      Box nymph
        Stage apterous
        Stage alate
      Box adult
        Stage apterous
          Stage fecundity
        Stage alate
          Stage fecundity
  OutputR 
    PageR 
      PlotR 
    PageR 
      PlotR 
  OutputWriter outputWriter
    OutputSelector selector
</code></pre>
<p>The <code>aphid</code> box is just a <code>Box</code>, which means it acts as a simple container of other boxes. Since we are anticipating a model including the fungus soon, we have put the <code>nymph</code> and <code>adult</code> stages inside a <code>susceptible</code> box (&#39;susceptible&#39; means &#39;uninfected&#39; in epidemiologist speak). Both are further divided into sub-populations of <code>apterous</code> and <code>alate</code> morphs. The <code>adult</code> box holds boxes inside for the individuals (<code>apterous</code> and <code>alate</code>) and their respective reproduction (<code>fecundity</code>).</p>
<p>The <code>param</code> box holds parameter values that must be the same across several boxes, as seen in the boxscript below.</p>
<pre><code class="listing"><a href="https://tildeweb.au.dk/au152367/input/models/aphid/crop-aphid-model.box">// crop-aphid-model.box&cudarrr;</a>
Simulation sim {
  Box param {
    &amp;k = 15
    &amp;juvenileApterousDuration = 172
    &amp;juvenileAlateDuration = 195 
    &amp;adultDuration = 300
    &amp;fecundityDuration = 100
    &amp;fecundity_k = 1
  }
  Calendar calendar {
	...
  }
  Records weather {
    ...
  } 
  Box wheat {
    ...
  }
  Box aphid {
    DayDegrees time{
      .T = weather[Tavg]
      .T0 = 3 
      .Topt = 18 
      .Tmax = 30 
    }  
    Box density {
      &amp;nymphs      = sum(../susceptible/nymph/*[content])
      &amp;adults      = sum(../susceptible/adult/*[content])
      &amp;total       = .[nymphs] + .[adults]
    }
    AphidImmigration immigration {
      .cropGrowthStage = cropGrowthStage[value]
      .toCropGrowthStage = 69
      .immigrationRate = 0.02
      .propExposedImmigrants = 0
      .k = param[k]
    }
    AphidNetReproduction netReproduction {
      .Tmin = 3 
      .Topt = 16.1 
      .Tmax = 30
      .R0opt = 51.6
      .temperature = weather[Tavg]
      .cropGrowthStage = cropGrowthStage[value]
      .optimumCropGrowthStageMin = 59
      .optimumCropGrowthStageMax   = 73
      .optimumCropFactor = 1.6
      .aphidDensity = ../density[total]
      .aphidDensityThreshold = 40 
      .alateFactor = 0.67
    }
    AphidOffspring offspring {
      .offspringTotal = sum(../*/adult/*/fecundity[outflow]) 
      .aphidDensity = ../density[total]
      .cropGrowthStage = cropGrowthStage[value]
    }
    AphidJuvenileSurvival survival{
      .cropGrowthStage = cropGrowthStage[value]
      .temperature = weather[Tavg]
    }
    Box susceptible {
      Box nymph {
        Stage apterous {
          .inflow       = ancestors::*/offspring[apterous]
          .timeStep     = ancestors::*/time[step]
          .growthFactor = ancestors::*/survival[value]
          .k = param[k]
          .duration = param[juvenileApterousDuration]
        }
        Stage alate {
          .inflow = ancestors::*/offspring[alate]
          .timeStep = ancestors::*/time[step]
          .k = param[k]
          .duration = param[juvenileAlateDuration]
          .growthFactor = ancestors::*/survival[value]
        }
      }
      Box adult {
        Stage apterous {
          .inflow = ancestors::*/nymph/apterous[outflow]
          .timeStep = ancestors::*/time[step]
          .duration = param[adultDuration]
          .k = param[k]
          Stage fecundity {
            .inflow = ancestors::*/nymph/apterous[outflow]
            .timeStep = ancestors::*/time[step]
            .duration = param[fecundityDuration]
            .k = param[fecundity_k]
            .growthFactor = ancestors::*/netReproduction[apterous]
          }
        }
        Stage alate {
          .inflow = ancestors::*/immigration[susceptible]
          .timeStep = ancestors::*/time[step]
          .duration = param[adultDuration]
          .k = param[k]
          Stage fecundity {
            .inflow = ancestors::*/immigration[susceptible]
            .timeStep = ancestors::*/time[step]
            .duration = param[fecundityDuration]
            .k = param[fecundity_k]
            .growthFactor = ancestors::*/netReproduction[alate]
          }
        }
      }
    } // susceptible
  } // aphid
  OutputR {
    .width = 5
    .height = 10
    PageR {
      .xAxis = calendar[date]
      PlotR {
        .ports = susceptible/*/*[value] | offspring[output::*]
      }
    }
    PageR {
      .xAxis = cropGrowthStage[value]
      PlotR {
        .ports = susceptible/*/*[value] | offspring[output::*]
        .ggplot = &quot;scale_x_continuous(breaks=10*(0:10))&quot;
      }
    }
  }
}
</code></pre>
<p>If you stumble over expressions, such as <code>.[nymph]</code> or <code>ancestors::*/time[step]</code>, please read up on <a href='#'>port paths</a>.</p>
<p>When you run the model,</p>
<pre><code class="command">> run models/aphid/crop-aphid-model.box
</code></pre>
<p>Aphid population dynamics are shown both on a date and a crop growth stage scale. Here are the two plots: </p>
<p><img src="https://tildeweb.au.dk/au152367//media/models/aphid/crop-aphid-model.png"></p>
<p>The alate offspring comes in two waves, the second wave due to decreasing aphid density caused by the ripening of the crop. This may or may not reflect reality. The interaction between aphid density and crop growth stage, which determines aphid fecundity, is complicated.</p>
</div>

<p class='hidden-anchor' id='crop-aphid-model-with-uncertainty'>xxx</p><div class='border-grey'>
<h2>Crop-aphid model with uncertainty</h2>
<p>In this extension of the model above, we include uncertainty on weather and a few model parameters. Every time you run the model, you will get a different output. In this boxscript listing, only the additional boxes and major changes are shown (left-out parts shown as <code>...</code>):</p>
<pre><code class="listing"><a href="https://tildeweb.au.dk/au152367/input/models/aphid/crop-aphid-model-ua.box">// crop-aphid-model-ua.box&cudarrr;</a>
Simulation sim {
  .iterations = 30
  .silent = TRUE
  SelectFile weatherFiles {
    .folder = &quot;weather&quot;
    .filter = &quot;*.txt&quot;
    .showFileNames = FALSE
  }
  Box random {
    RandomiserStratified randomiser {
    }
    RandomUniformInt k {
      .min = 15
      .max = 30
    }
    RandomUniformInt fileNumber {
      .min = 1
      .max = weatherFiles[numFiles]
    }
    RandomNormal cropAtStart {
      .min = 10
      .max = 30 
    }
    RandomNormal cropHalfways {
      .min = 750 
      .max = 850 
    }
  }
  ...
  Records weather {
    .fileName =  ./files[fileNamePath]   
    .ignoreYear = TRUE
    SelectFile files {
      .folder = &quot;weather&quot;
      .filter = &quot;*.txt&quot;
      .selectFileNumber = random/fileNumber[value]
      .showFileNames = FALSE
    }
  } 
  Box wheat{
    CropGrowthStage cropGrowthStageModel {
      .valueAtStart       = random/cropAtStart[value]
      .dayDegreesHalfways = random/cropHalfways[value]
      .slope              = 2.8
      .dayDegrees = ./time[total]
      CropIsGrowing isGrowing {
        .temperature = weather[Tavg] 
      }
      DayDegrees time{
        .T = weather[Tavg]
        .T0 = 0
        .isTicking = ../isGrowing[value]
      }
    }
    Box cropGrowthStage {
      &amp;value = if exists(weather[GrowthStage]) then weather[GrowthStage] 
                   else ../cropGrowthStageModel[value]
    }
  }
  ...
  OutputR {
    .scripts = &quot;crop-aphid-model-ua.R&quot;
    OutputText {
      .ports = calendar[date] | cropGrowthStage[value] | 
               susceptible/*/*[value] | offspring[output::*] 
    }
  }
}
</code></pre>
<p>The <code>random</code> box draws numbers for the uncertain parameters of which there are four:</p>
<ul>
<li><code>k</code></li>
<li><code>fileNumber</code></li>
<li><code>cropAtStart</code></li>
<li><code>cropHalfways</code></li>

</ul>
<p>The very first child of <code>random</code> determines the method by which to draw random numbers. In this boxscript, stratified random sampling has been chosen.</p>
<p>The <code>k</code> parameter will achieve a number between <code>15</code> and <code>30</code> before each iteration of the simulation. It is used by <code>immigration</code> and the four aphid sub-populations. You can use <a href='#'>list</a> with the <code>x</code> option to verify this:</p>
<pre><code class="command">&gt; list random/k x</code>
<code class="output">
RandomUniformInt k
  &gt;value = 21
    &gt;&gt; sim/aphid/immigration[k]
    &gt;&gt; sim/aphid/susceptible/nymph/apterous[k]
    &gt;&gt; sim/aphid/susceptible/nymph/alate[k]
    &gt;&gt; sim/aphid/susceptible/adult/apterous[k]
    &gt;&gt; sim/aphid/susceptible/adult/alate[k]
</code></pre>
<p>The <code>cropGrowthStageModel</code> box uses the random values for <code>cropAtStart</code> and <code>cropHalfways</code>.</p>
<p><code>fileNumber</code> represents a bit of a hack to choose at random, a file with suffix <code>txt</code> within the <code>weather</code> sub-folder. Two <code>SelectFile</code> boxes do the trick. The first one (<code>weatherFiles</code>) is queried by <code>fileNumber</code> about the total number of candidate files. The second one (<code>files</code>) is used to pick a file by the random number (the files are considered numbered alphabetically), which ultimately is the one opened by <code>weather</code>.</p>
<p><code>iterations</code> have been set to <code>30</code>, which means the model will be running 30 times. To avoid an avalanche of status messages on the screen, <code>silent</code> has been set to <code>TRUE</code>. You should try setting it to <code>FALSE</code> (its default value), just to notice the difference.</p>
<p>The <code>OutputR</code> box has been set to run a dedicated R script to process the simulation output:</p>
<pre><code class='listing'><a href="https://tildeweb.au.dk/au152367/input/models/aphid/crop-aphid-model-ua.R"># crop-aphid-model-ua.R&cudarrr;</a>
densities = colnames(sim)[3:9]

M = melt(sim, id.vars=c(&quot;iteration&quot;, &quot;date&quot;), measure.vars=densities, 
         variable.name=&quot;Variable&quot;, value.name=&quot;Value&quot;)
open_plot_window(5,10)
P = ggplot(M, aes(date, Value, colour=Variable, group=iteration)) +
  geom_line(alpha=0.3) +
  labs(y=&quot;&quot;) +
  theme(legend.position=&quot;none&quot;) +
  facet_wrap(~Variable, ncol=1, scales=&quot;free&quot;)
print(P)

M = melt(sim, id.vars=c(&quot;iteration&quot;, &quot;cropGrowthStage&quot;), measure.vars=densities, 
         variable.name=&quot;Variable&quot;, value.name=&quot;Value&quot;)
open_plot_window(5,10)
P = ggplot(M, aes(cropGrowthStage, Value, colour=Variable, group=iteration)) +
  geom_line(alpha=0.3) +
  scale_x_continuous(breaks=10*(0:10)) +
  labs(y=&quot;&quot;) +
  theme(legend.position=&quot;none&quot;) +
  facet_wrap(~Variable, ncol=1, scales=&quot;free&quot;)
print(P)

</code></pre>
<p>When you run the simulation, </p>
<pre><code class="command">> run models/aphid/crop-aphid-model-ua.box
</code></pre>
<p>the R script will be executed in R, when you paste the clipboard there. The plots are similar to the one before but now show output uncertainty as 30 overlaid curves for each variable:</p>
<img src="https://tildeweb.au.dk/au152367//media/models/aphid/crop-aphid-model-ua.png">
<p>Aphid dynamics are seen to be less uncertain on a crop growth stage scale than on a date scale.</p>
</div>

<p class='hidden-anchor' id='crop-aphid-fungus-model'>xxx</p><div class='border-grey'>
<h2>Crop-aphid-fungus model</h2>
<p>We are now ready to tackle the full, tri-trophic model. For that purpose we need to add the fungus. However, it is not represented as a fungus population directly (e.g. as fungal biomass or number of spores in various compartments, such as soil and hosts). Lack of data does not allow us that detail. Instead, the fungus is represented in</p>
<ul>
<li>exposed immigrants</li>
<li>exposed aphids (nymps and adults, apterous and alate)</li>
<li>aphid cadavers</li>

</ul>
<p>Remember that exposed means &#39;infected&#39;. Furthermore, note that we call nymphs, that will develop into alate adults, &#39;alate&#39;; the correct word is &#39;alatiform&#39; but we ignore that distinction in the code to make our boxscripts more readable.</p>
<p>Here is the complete boxscript. It has been broken into pieces to allow comments as we go:</p>
<pre><code class="listing"><a href="https://tildeweb.au.dk/au152367/input/models/aphid/crop-aphid-fungus-model.box">// crop-aphid-fungus-model.box&cudarrr;</a>
Simulation sim {
  Box param {
    &amp;k = 15
    &amp;juvenileApterousDuration = 172
    &amp;juvenileAlateDuration = 195 
    &amp;adultDuration = 300
    &amp;fecundityDuration = 100
    &amp;fecundity_k = 1
    &amp;lethalTime = 80
  }
  Calendar calendar {
    .begin = 01/04/2004
    .end   = 31/08/2004
  }
  Records weather {
    .fileName = &quot;weather/Aarnes_2004.txt&quot;
  } 
  Box wheat{
    CropGrowthStage cropGrowthStageModel {
      .valueAtStart       = 20.0
      .dayDegreesHalfways = 800.0
      .slope              = 2.8
      .dayDegrees = ./time[total]
      CropIsGrowing isGrowing {
        .temperature = weather[Tavg] 
      }
      DayDegrees time{
        .T = weather[Tavg]
        .T0 = 0
        .isTicking = ../isGrowing[value]
      }
    }
    Box cropGrowthStage {
      &value = if exists(weather[GrowthStage]) then weather[GrowthStage] 
               else ../cropGrowthStageModel[value]
    }
  }
  ...
</code></pre>
<p>So far nothing much has changed, only a few additions to <code>param</code>. But here goes! We invoke a <a href='#'>Maker</a> box to construct two copies of the box declared in line  5 below. They will be named <code>withoutFungus</code> and <code>withFungus</code> as defined in line 4 and also commented in line 5:</p>
<pre><code class="listing">...
Maker system {
  // The system contains two aphid populations, 
  // identical except for the proportion of exposed immigrants
  .names = c(&quot;withoutFungus&quot;, &quot;withFungus&quot;)
  Box { // withoutFungus or withFungus
    DayDegrees time{
      .T = weather[Tavg]
      .T0 = 3 
      .Topt = 18 
      .Tmax = 30 
    } 
    ...
</code></pre>
<p>In effect the whole aphid model will be replicated, the two copies having the same structure and sharing all parameter values. They are created as children of <code>system</code> and can referred to by  <code>system/withoutFungus</code> and <code>system/withFungus</code>. </p>
<p>We add a <code>fungusTime</code> to keep track of infection development and a few extra ports in <code>aphidDensity</code> to count aphids by their infection status (<code>susceptible</code>,  <code>exposed</code> and <code>cadavers</code>). The <code>immigration</code> box asks if the name of its parent is <code>withFungus</code>, in which case 25% of the immigrants will arrive exposed; otherwise zero. Here, <code>name</code> is a BoxScript function. <a href='#'>Paths</a> in BoxScript must include a port, but it can be left empty to refer to a box. Hence, we arrive at the expression <code>name(..[])</code>. </p>
<pre><code class="listing">...
DayDegrees fungusTime {
  .T = weather[Tavg]
  .T0 = 2 
  .Topt = 18 
  .Tmax = 30 
}
Box aphidDensity {
  &amp;nymphs      = sum(../*/nymph/*[content])
  &amp;adults      = sum(../*/adult/*[content])
  &amp;total       = .[nymphs] + .[adults]
  &amp;susceptible = sum(../susceptible/*/*[content])
  &amp;exposed     = sum(../exposed/*/*[content])
  &amp;cadavers    = sum(../infectious/cadavers[content])
}
AphidImmigration immigration {
  .cropGrowthStage = cropGrowthStage[value]
  .toCropGrowthStage = 69
  .immigrationRate = 0.02
  .propExposedImmigrants = if name(..[]) == &quot;withFungus&quot;
                           then 0.25
                           else 0.0
  .k = param[k]
}
...
</code></pre>
<p>The two systems (<code>system/withoutFungus</code> and <code>system/withFungus</code>) do not interact but run in parallel (logically, not in terms of computer processes). This allows comparison between the two systems of the simulation results, since they have everything in common, except for the proportion of exposed immigrants, as defined in lines 19-21 above.</p>
<p>For reproduction and survival, nothing has changed but we need to be carefull with our references. Thus there are two ports on the path <code>aphidDensity[total]</code>, namely <code>withoutFungus/aphidDensity[total]</code> and <code>withFungus/aphidDensity[total]</code>. To get the right one, we must use the relative path <code>../aphidDensity[total]</code>:</p>
<pre><code class="listing">...
AphidNetReproduction netReproduction {
  .Tmin = 3 
  .Topt = 16.1 
  .Tmax = 30
  .R0opt = 51.6
  .temperature = weather[Tavg]
  .cropGrowthStage = cropGrowthStage[value]
  .optimumCropGrowthStageMin = 59
  .optimumCropGrowthStageMax   = 73
  .optimumCropFactor = 1.6
  .aphidDensity = ../aphidDensity[total]
  .aphidDensityThreshold = 40 
  .alateFactor = 0.67
}
AphidOffspring offspring {
  .offspringTotal = sum(../*/adult/*/fecundity[outflow]) 
  .aphidDensity = ../aphidDensity[total]
  .cropGrowthStage = cropGrowthStage[value]
}
AphidJuvenileSurvival survival{
  .cropGrowthStage = cropGrowthStage[value]
  .temperature = weather[Tavg]
}
...
</code></pre>
<p>The <code>Stage</code> boxes must be extended to allow outflow in a new direction. A certain proportion, set by the model for <code>infectionRate</code>, is leaving susceptible stages to become exposed (further down in the boxscript). First for the <code>nymph</code> stages:</p>
<pre><code class="listing">...
Box susceptible {
  Box nymph {
    Stage apterous {
      .inflow       = ancestors::*/offspring[apterous]
      .timeStep     = ancestors::*/time[step]
      .growthFactor = ancestors::*/survival[value]
      .k = param[k]
      .duration = param[juvenileApterousDuration]
      .phaseOutflowProportion = ancestors::*/infectious/infectionRate[value]
    }
    Stage alate {
      .inflow = ancestors::*/offspring[alate]
      .timeStep = ancestors::*/time[step]
      .k = param[k]
      .duration = param[juvenileAlateDuration]
      .growthFactor = ancestors::*/survival[value]
      .phaseOutflowProportion = ancestors::*/infectious/infectionRate[value]
    }
  }
  ...
</code></pre>
<p>Then for the <code>adult</code> stages; here, we must remember to let the infected proportion of <code>fecundity</code> follow the adults:</p>
<pre><code class="listing">  ...
  Box adult {
    Stage apterous {
      .inflow = ancestors::*/nymph/apterous[outflow]
      .timeStep = ancestors::*/time[step]
      .duration = param[adultDuration]
      .k = param[k]
      .phaseOutflowProportion = ancestors::*/infectious/infectionRate[value]
      Stage fecundity {
        .inflow = ancestors::*/nymph/apterous[outflow]
        .timeStep = ancestors::*/time[step]
        .duration = param[fecundityDuration]
        .k = param[fecundity_k]
        .growthFactor = ancestors::*/netReproduction[apterous]
        .phaseOutflowProportion = ancestors::*/infectious/infectionRate[value]
      }
    }
    Stage alate {
      .inflow = ancestors::*/immigration[susceptible]
      .timeStep = ancestors::*/time[step]
      .duration = param[adultDuration]
      .k = param[k]
      .phaseOutflowProportion = ancestors::*/infectious/infectionRate[value]
      Stage fecundity {
        .inflow = ancestors::*/immigration[susceptible]
        .timeStep = ancestors::*/time[step]
        .duration = param[fecundityDuration]
        .k = param[fecundity_k]
        .growthFactor = ancestors::*/netReproduction[alate]
        .phaseOutflowProportion = ancestors::*/infectious/infectionRate[value]
      }
    }
  }
} // susceptible
...
</code></pre>
<p>Notice that the <code>inflow</code> to the <code>nymph</code> stages (<code>apterous</code> and <code>alate</code>) originates from the <code>offspring</code> box, while the <code>inflow</code> to the <code>adult</code> <code>apterous</code> stage originates from individuals finishing their <code>apterous</code> <code>nymph</code> stage. You would expect the same kind of <code>inflow</code> to the <code>adult</code> <code>alate</code> stage; however, alate adults are assumed to fly away immediately. Hence, alate adults originate only has immigrants (which are assumed to stay) received from the <code>immigration</code> box.</p>
<p>No nymphs hatch as exposed (the fungus is only laterally transmitted). Hence the only <code>inflow</code> to the <code>exposed</code> <code>nymph</code> stages is from the infection of susceptible nymphs (just calculated above):</p>
<pre><code class="listing">...
Box exposed {
  Box nymph {
    StageAndPhase apterous {
      .timeStep = ancestors::*/time[step]
      .k = param[k]
      .duration = param[juvenileApterousDuration]
      .growthFactor = ancestors::*/survival[value]
      .phaseInflow = ancestors::*/susceptible/nymph/apterous[phaseOutflow]
      .phaseTimeStep = ancestors::*/fungusTime[step]
      .phaseK = param[k]
      .phaseDuration = param[lethalTime]
    }
    StageAndPhase alate {
      .timeStep = ancestors::*/time[step]
      .k = param[k]
      .duration = param[juvenileAlateDuration]
      .growthFactor = ancestors::*/survival[value]
      .phaseInflow = ancestors::*/susceptible/nymph/alate[phaseOutflow]
      .phaseTimeStep = ancestors::*/fungusTime[step]
      .phaseK = param[k]
      .phaseDuration = param[lethalTime]
    }
  } // nymph
  ...
</code></pre>
<p>Exposed adults, on the other hand may enter through two pathways: as exposed nymphs developing into exposed adults, or as susceptible adults getting infected. They enter below as the inputs <code>inflow</code> and <code>phaseInflow</code>, respectively:</p>
<pre><code class="listing">...
Box adult {
  StageAndPhase apterous {
    .inflow = ancestors::*/nymph/apterous[outflow]
    .timeStep = ancestors::*/time[step]
    .duration = param[adultDuration]
    .k = param[k]
    .phaseInflow = ancestors::*/susceptible/adult/apterous[phaseOutflow]
    .phaseTimeStep = ancestors::*/fungusTime[step]
    .phaseK = param[k]
    .phaseDuration = param[lethalTime]
    StageAndPhase fecundity {
       // No inflow because exposed/nymphs don&#39;t reproduce as adults
      .timeStep = ancestors::*/time[step]
      .duration = param[fecundityDuration]
      .k = param[fecundity_k]
      .growthFactor = ancestors::*/netReproduction[apterousExposed] 
      .phaseInflow = ancestors::*/susceptible/adult/apterous/fecundity[phaseOutflow]
      .phaseTimeStep = ancestors::*/fungusTime[step]
      .phaseK = param[k]
      .phaseDuration = param[lethalTime]
    }
  }
  StageAndPhase alate {
    .inflow = ancestors::*/immigration[exposed]
    .timeStep = ancestors::*/time[step]
    .duration = param[adultDuration]
    .k = param[k]
    .phaseInflow = ancestors::*/susceptible/adult/alate[phaseOutflow]
    .phaseTimeStep = ancestors::*/fungusTime[step]
    .phaseK = param[k]
    .phaseDuration = param[lethalTime]
    StageAndPhase fecundity {
      // Exposed immigrants reproduce after arriving
      .inflow = ancestors::*/immigration[exposed]
      .timeStep = ancestors::*/time[step]
      .duration = param[fecundityDuration]
      .k = param[fecundity_k]
      .growthFactor = ancestors::*/netReproduction[alateExposed] 
      .phaseInflow = ancestors::*/susceptible/adult/alate/fecundity[phaseOutflow]
      .phaseTimeStep = ancestors::*/fungusTime[step]
      .phaseK = param[k]
      .phaseDuration = param[lethalTime]
    }
  }
} // adult
...
</code></pre>
<p>The <code>exposed</code> box contains one extra child to keep track of cadavers:</p>
<pre><code>  ...
  CadaverConversion succumbed {
    .succumbedApterousNymphs = sum(ancestors::*/nymph/apterous[phaseOutflow])
    .succumbedAlateNymphs    = sum(ancestors::*/nymph/alate[phaseOutflow])
    .succumbedApterousAdults = sum(ancestors::*/adult/apterous[phaseOutflow])
    .succumbedAlateAdults    = sum(ancestors::*/adult/alate[phaseOutflow])
  }
} // exposed
...
</code></pre>
<p>Our model in the taxonomy of epidemiological models is an SEI (susceptible-exposed-infectious) model. Hence, to our collection of system boxes (<code>system/susceptible</code> and <code>system/exposed</code>) we now add <code>system/infectious</code>, which contains child boxes to hold <code>cadavers</code> and to calculate <code>infectionRate</code>:</p>
<pre><code class="listing" >...
Box infectious {
  OnOff isSporulating {
    .x = weather[RHmax]
    .xOn = 95
    .xOff = 999 
  }
  CadaverTime time {
    .isSporulating = ../isSporulating[isOn]
    .timeStep = ancestors::*/fungusTime[step]
    .rhAccelaration = 2
  }
  Stage cadavers {
    .inflow = ancestors::*/exposed/succumbed[cadavers]
    .timeStep = ../time[step]
    .duration = 100
    .k = param[k]
  }
  InfectionRate infectionRate {
    .isSporulating = ../isSporulating[isOn]
    .cadavers = ../cadavers[content]
    .transmissionEfficiency = 0.2
  }
} // infectious
...
</code></pre>
<p>The final child of <code>system</code> contains summary statistics, including <code>yield</code>:</p>
<pre><code class="listing">      ...
      Box diagnostics {
        Accumulator aphidDays {
          .change = ancestors::*/aphidDensity[total]
        }
        Accumulator cadaverDays {
          .change = ../../infectious/cadavers[content]
        }
        Prevalence prevalence {
          .aphidDensity   = ancestors::*/aphidDensity[total]
          .exposedDensity = ancestors::*/aphidDensity[exposed]
          .cadaverDensity = ancestors::*/aphidDensity[cadavers]
        }
        AphidIndex aphidIndex {
          .nymphs = ancestors::*/aphidDensity[nymphs]
          .adults = ancestors::*/aphidDensity[adults]
        }
        aphid::Yield yield {
          .aphidIndex = ../aphidIndex[value]
          .cropGrowthStage = cropGrowthStage[value]
        }
      } // diagnostics
    } // withoutFungus or withFungus
  } // system
  ...
</code></pre>
<p>The two pages of output are both shown as plots in two colums, filled in column-first (that&#39;s what <code>direction</code> is for; change it to <code>&quot;row&quot;</code> and notice the difference):</p>
<pre><code class="listing">  ...
  OutputR {
    .width = 7
    .height = 7
    PageR {
      .xAxis = calendar[date]
      PlotR {
        .ports = system/*/*/*/Stage::*[value] | Stage::cadavers[value]
        .ncol = 2
        .direction = &quot;col&quot;
        .ggplot = &quot;scale_colour_manual(values=c(rep(red,5), rep(blue,5)))&quot;
      }
    }
    PageR {
      .xAxis = calendar[date]
      PlotR {
        .ports = diagnostics/aphidDays[value] | diagnostics/cadaverDays[value] | 
                 diagnostics/prevalence[output::*] |
                 diagnostics/yield[yield]
        .ncol = 2
        .direction = &quot;col&quot;
        .ggplot = &quot;scale_colour_manual(values=c(rep(red,5), rep(blue,5)))&quot;
      }
    }
  } // OutputR
} // sim (end-of-script)
</code></pre>
<p>When we run the model, </p>
<pre><code>run models/aphid/crop-aphid-fungus-model.box
</code></pre>
<p>as expected, the fungus is shortening the duration of the aphid outbreak. Cadavers are only present in the system with fungus:</p>
<p><img src="https://tildeweb.au.dk/au152367//media/models/aphid/crop-aphid-fungus-model-aphids.png"></p>
<p>Despite the obvious effect of the fungus on the density of aphids, <code>yield</code> does not seem much improved:
<img src="https://tildeweb.au.dk/au152367//media/models/aphid/crop-aphid-fungus-model-diagnostics.png"></p>
</div>

<p class='hidden-anchor' id='biocontrol-model-with-uncertainty-analysis'>xxx</p><div class='border-grey'>
<h2>Biocontrol model with uncertainty analysis</h2>
<p>The <a href="https://tildeweb.au.dk/au152367/input/models/aphid/biocontrol-model.box">biocontrol-model.box&cudarrr;</a> script adds uncertain parameters, as we already saw in <a href='#crop-aphid-model-with-uncertainty'>Crop-aphid model with uncertainty</a>, but with even more uncertain parameters, most of them pertaining to the fungus. These are the exact same uncertain 11 parameters that also appear in the scientific paper on the model (Saussure et al., submitted 2022). Here is the <code>random</code> box from the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/biocontrol.box">biocontrol.box&cudarrr;</a> script:</p>
<pre><code = class="listing">...
Box random {
  RandomiserStratified randomiser {
  }
  RandomUniformInt k {
    .min = 15
    .max = 30
  }
  RandomUniformInt fileNumber {
    .min = 1
    .max = weatherFiles[numFiles]
  }
  RandomNormal cropAtStart {
    .min = 10
    .max = 30 
  }
  RandomNormal cropHalfways {
    .min = 750 
    .max = 850 
  }
  RandomNormal propExposedImmigrants {
    .min = 0.1
    .max = 0.7
  }
  RandomNormal lethalTime {
    .min = 50 
    .max = 115
  }
  RandomNormal immunityCost {
    .min = 0
    .max = 0.4
  }
  RandomNormal sporulationOn {
    .min = 80 
    .max = 99 
  }
  RandomNormal cadaverDuration {
    .min = 48 
    .max = 112 
  }
  RandomNormal timeAcceleration {
    .min = 1
    .max = 3
  }
  RandomNormal transmissionEfficiency {
    .min = 0.05
    .max = 0.5 
  }
}
</code></pre>
<p>You can open the boxscript yourself and find how each random parameter is used in the model. The <code class="command">list</code> command with the <code class="command">x</code> option comes in handy (some output abbreviated <code class="output">...</code>):</p>
<pre><code class="command">> run models/aphid/biocontrol-model.box</code>
<code class="output">...</code>
<code class="command">> list random/RandomBase::* x</code>
<code class="output">RandomUniformInt k
  &gt;value = 30
    &gt;&gt; sim/system/withoutFungus/immigration[k]
    &gt;&gt; sim/system/withoutFungus/susceptible/nymph/apterous[k]
    &gt;&gt; sim/system/withoutFungus/susceptible/nymph/alate[k]
    ...
    &gt;&gt; sim/system/withFungus/immigration[k]
    &gt;&gt; sim/system/withFungus/susceptible/nymph/apterous[k]
    &gt;&gt; sim/system/withFungus/susceptible/nymph/alate[k]
    ...
RandomUniformInt fileNumber
  &gt;value = 6
    &gt;&gt; sim/weather/files[selectFileNumber]
RandomNormal cropAtStart
RandomNormal cropHalfways
RandomNormal propExposedImmigrants
  &gt;value = 0.508888
    &gt;&gt; sim/system/withoutFungus/immigration[propExposedImmigrants]
    &gt;&gt; sim/system/withFungus/immigration[propExposedImmigrants]
RandomNormal lethalTime
  &gt;value = 88.8232
    &gt;&gt; sim/system/withoutFungus/exposed/nymph/apterous[phaseDuration]
    &gt;&gt; sim/system/withoutFungus/exposed/nymph/alate[phaseDuration]
    &gt;&gt; sim/system/withoutFungus/exposed/adult/apterous/fecundity[phaseDuration]
    ...
	&gt;&gt; sim/system/withFungus/exposed/nymph/alate[phaseDuration]
    &gt;&gt; sim/system/withFungus/exposed/adult/apterous/fecundity[phaseDuration]
    &gt;&gt; sim/system/withFungus/exposed/adult/apterous[phaseDuration]
    ...
RandomNormal immunityCost
  &gt;value = 0.0987229
    &gt;&gt; sim/system/withoutFungus/netReproduction[immunityCost]
    &gt;&gt; sim/system/withFungus/netReproduction[immunityCost]
RandomNormal sporulationOn
  &gt;value = 84.5715
    &gt;&gt; sim/system/withoutFungus/infectious/isSporulating[xOn]
    &gt;&gt; sim/system/withFungus/infectious/isSporulating[xOn]
RandomNormal cadaverDuration
  &gt;value = 86.299
    &gt;&gt; sim/system/withoutFungus/infectious/cadavers[duration]
    &gt;&gt; sim/system/withFungus/infectious/cadavers[duration]
RandomNormal timeAcceleration
  &gt;value = 1.90676
    &gt;&gt; sim/system/withoutFungus/infectious/time[rhAccelaration]
    &gt;&gt; sim/system/withFungus/infectious/time[rhAccelaration]
RandomNormal transmissionEfficiency
  &gt;value = 0.305888
    &gt;&gt; sim/system/withoutFungus/infectious/infectionRate[transmissionEfficiency]
    &gt;&gt; sim/system/withFungus/infectious/infectionRate[transmissionEfficiency]
&gt; 
</code></pre>
<p>A <code>Biocontrol</code> box has been added near the end of the boxscript, and the output is now sent to a dedicated R script (<a href="https://tildeweb.au.dk/au152367/input/models/aphid/biocontrol.R">biocontrol.R&cudarrr;</a>): 
<pre><code class="listing">...
Biocontrol biocontrol {
  .aphidPressureWithoutF = withoutFungus/diagnostics/aphidDays[value] 
  .aphidPressureWithF = withFungus/diagnostics/aphidDays[value] 

  .yieldWithoutF = withoutFungus/diagnostics/yield[yield] 
  .yieldWithF = withFungus/diagnostics/yield[yield] 
  
  .cropGrowthStage = cropGrowthStage[value]
  .prevalence = withFungus/diagnostics/prevalence[exposed]
  .cadaverPrevalence = withFungus/diagnostics/prevalence[cadavers]
}
OutputR {
  .scripts = &quot;biocontrol.R&quot;
  OutputText {
    .ports = calendar[date] | biocontrol[output::*]
  }
}
...
</code></pre>
<p>The <code>biocontrol</code> box compares the outputs of <code>system/withoutFungus</code> and <code>system/withFungus</code>. When you run the model,</p>
<pre><code class="command">> run models/aphid/biocontrol-model.box
</code></pre>
<p>it will run for 30 iterations. However, here I have changed it to just one iteration</p>
<pre><code class="listing"><a href="https://tildeweb.au.dk/au152367/input/models/aphid/biocontrol-model.box">// biocontrol-model.box&cudarrr;</a>
Simulation sim {
  .iterations = 1
  ...
</code></pre>
<p>to approach the upcoming complexity in baby steps. Here is the output:
<img src="https://tildeweb.au.dk/au152367//media/models/aphid/biocontrol-1.png"></p>
<p>What we see changing with time, as an effect of the fungus, are</p>
<ul>
<li>the reduction in aphid pressure (area under the aphid density curve, so-called aphid-days)</li>
<li>the improvement in yield (in %-points)</li>
<li>the maximum prevalence of cadavers and the growth stage when that occurred</li>
<li>the maximum prevalence (of exposed aphids) and the growth stage when that occurred</li>

</ul>
<p>We also see the percentage of cadavers at  growth stage 43, 61 and 73.</p>
<p>Since the model contains uncertain parameters, the course of these nine curves (which we will call model <em>outcomes</em>) will be different for every iteration we run the model. But notice, that the course of the curves is not that important, in fact, we are just interested in the <em>final value</em> for each of the outcomes. They tell us everything (or, at least, they summerise the salient points) about the effects of biocontrol.</p>
<p>When <em>you</em> run the model, you will see 30 curves overlaid for each model outcome:</p>
<p><img src="https://tildeweb.au.dk/au152367//media/models/aphid/biocontrol-30.png"></p>
<p>Imagine now that we picked just the final values for all of these curves. We could then show a histogram for each of the nine outcomes. These histograms would should how uncertain model outcomes are, all due to the uncertainty of the 11 model parameters. If you change iterations to 100, or any number higher then that, you will be rewarded by pastel-coloured histograms:
<img src="https://tildeweb.au.dk/au152367//media/models/aphid/biocontrol-100.png"></p>
<p>An obvious question, once you have celebrated your success and posted this beautiful figure (which illustrates an <strong>uncertainty analysis</strong>) on the wall, is, which of the 11 uncertain parameters are most influential on each of these nine model outcomes? That is the purpose of <strong>sensitivity analysis</strong>, which we turn to next.</p>
</div>

<p class='hidden-anchor' id='setting-up-the-analysis'>xxx</p><p class='hidden-anchor' id='biocontrol-with-sensitivity-analysis'>xxx</p><div class='border-grey'>
<h2>Biocontrol with sensitivity analysis</h2>
<h3><li>Setting up the analysis</li></h3>
<p>It will take us only a little editing of the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/biocontrol-model.box">biocontrol-model.box&cudarrr;</a> script to add sensitivity analysis (SA). First, you should realise that SA is very computing intensive, so we need to optimise our sampling strategy for the random numbers. We will shift from stratified random sampling (which optimises the random sampling inside the distribution of each model parameter)  to Sobol&#39; quasi-random numbers (which optimise the random sampling inside the 11-dimensional distribution across all 11 model parameters). This is set up at the top of the boxscript, where we replace <code>RandomiserStratified</code> with <code>RandomiserSobolSequence</code>:</p>
<pre><code class="listing"><a href="https://tildeweb.au.dk/au152367/input/models/aphid/biocontrol-model-sa.box">// biocontrol-model-sa.box&cudarrr;</a>
Simulation sim {
  .iterations = 832 // 832 (for demonstration) or 1703936 (for analysis)
  .silent = TRUE
  .unattended = TRUE
  .stopIteration = !question[accepted]
  PopUp question {
    .title = "You are about to run a simulation that will potentially 
             last many hours (at ~40,000 simulations per hour)&quot;
    .text = &quot;Do you want to continue?&quot;
    .icon = &quot;question&quot;
    .buttons = c(&quot;Yes&quot;, &quot;No&quot;)
  }
  SelectFile weatherFiles {
    .folder = &quot;weather&quot;
    .filter = &quot;*.txt&quot;
    .showFileNames = FALSE
  }
  Box random {
    RandomiserSobolSequence randomiser {
      .doSensitivityAnalysis = TRUE
      .bootstrapSize = 100 // 100 (for demonstration) or 10000 (for analysis)
    }
    RandomUniformInt k {
      .min = 15
      .max = 30
    }
    ...
}
</code></pre>
<p>Since your computer is likely to lock up during this lengthy simulation, <code>unattended</code> has been set <code>TRUE</code>. Otherwise, you will get an (unharmful) error message when the simulation has finished, because the clipboard would have been locked as well.</p>
<p>When we are using Sobol&#39; numbers we should be careful to make a balanced sampling of parameter space. To obtain that, the number of simulation <code>iterations</code> must equal \(2^n(p+2)\), where \(n\) is a whole, positive number, and \(p\) is the number of parameters sampled (we&#39;ve got 11). Hence, these are all valid options:</p>
$$
\begin{split}
2^1\cdot(11+2) &= 26 \\
2^2\cdot(11+2) &= 52 \\
2^3\cdot(11+2) &= 104 \\
\ldots \\
2^{17}\cdot(11+2) &= 1,703,936 \\
\ldots
\end{split}
$$
<p>The last number listed is the one used in the published paper. That&#39;s a weekend job! For a quick demonstration we will stick to 832 iterations but you will also be shown, what came out of the weekend job. If you set <code>iterations</code> to an invalid number, the simulation will stop immediately if you try to run it. As a service, you will get suggestions to valid values for <code>iterations</code> near the number you picked. So, if you want in the range of, say, 50,000 iterations, write that, and you will be told nearby valid numbers.</p>
<p>To carry out the sensitivity analysis on the simulation output, we must set <code>doSensitivityAnalysis</code> to <code>TRUE</code> and choose a reasonable <code>bootstrapSize</code> to do statistics on the sensitivity indices. A <code>bootstrapSize</code> of 10,000 seems to be a standard choice in literature but here we&#39;ll use 100 for demonstration.</p>
<p>The <a href='#'>Popup</a> box is there to warn the user and give the option of regretting ever having started the simulation. The answer is used by <code>sim</code> to stop the simulation in the first step, if <code>stopIteration</code> is <code>TRUE</code>.</p>
<h3 id='showing-the-results'><li>Showing the results</li></h3>
<p>The <a href='#'>OutputR</a> box contains four child boxes. Here are the first two:</p>
<pre><code class="listing">...
OutputR {
  .saveDataFrame = TRUE
  OutputSelector {
    .final = TRUE
  }
  PageR {
    .xAxis = random/*[value]
    PlotR {
      .ports = biocontrol[output::*]
      .maxData = 1000
      .ggplot = &quot;geom_smooth(colour=&#39;yellow&#39;)&quot;
    }
  }
  ...
}
</code></pre>
<p>We ask for the output to be saved in a data frame (<code>saveDataFrame</code> is <code>TRUE</code>) to keep it for later; the simulation may have taken many hours and we don&#39;t want to lose it. We invoke the <a href='#'>OutputSelector</a> to write only the <code>final</code> values of each iteration. We are going to use the outputs generated by the <a href='#'>Biocontrol</a> box, and for those the final values nicely summarise the effect of biocontrol.</p>
<p>The first <a href='#'>PageR</a> box puts all 11 uncertain parameters on the x-axis and all 9 biocontrol outputs on the y-axis. Let&#39;s decipher those two paths for <code>xAxis</code> and <code>ports</code>. But first we need to run the model (this took 20 seconds on my computer),</p>
<pre><code class="command">> run models/aphid/biocontrol-model-sa.box
</code></pre>
<p>We can use the <a href='#'>find</a> command to find out what&#39;s on the path specified for the <code>xAxis</code> above (<code>random/*[value]</code>):</p>
<pre><code class="command">&gt; find random/*[value]</code>
<code class="output">Port int    sim/random/k[value]
Port int    sim/random/fileNumber[value]
Port double sim/random/cropAtStart[value]
Port double sim/random/cropHalfways[value]
Port double sim/random/propExposedImmigrants[value]
Port double sim/random/lethalTime[value]
Port double sim/random/immunityCost[value]
Port double sim/random/sporulationOn[value]
Port double sim/random/cadaverDuration[value]
Port double sim/random/timeAcceleration[value]
Port double sim/random/transmissionEfficiency[value]
</code></pre>
<p>Check. Those are the 11 parameters we want on the x-axis. Now for <code>biocontrol[output::*]</code>:</p>
<pre><code class="command">&gt; find biocontrol[output::*]</code>
<code class="output">Port double sim/biocontrol[aphidPressureDifference]
Port double sim/biocontrol[yieldImprovement]
Port double sim/biocontrol[percentageCadaversGs43]
Port double sim/biocontrol[percentageCadaversGs61]
Port double sim/biocontrol[percentageCadaversGs73]
Port double sim/biocontrol[maxCadaverPrevalence]
Port double sim/biocontrol[maxCadaverPrevalenceGS]
Port double sim/biocontrol[maxPrevalence]
Port double sim/biocontrol[maxPrevalenceGS]
</code></pre>
<p>Check. We&#39;ve got nine of those.</p>
<p>Since we were running the simulation <code>unattended</code> (see above), you must type in the <a href='#'>clip</a> command to fill the clipboard after the simulation has finished. When you paste that into R, R will do the bootstrapping on the sensitivity indices. This  took 15 seconds on my machine. The first thing you will see, is this impressive 11 by 9 plot:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/biocontrol-sa-1.png"></p>
<p>Notice that in the <a href='#'>PlotR</a> box, we set <code>maxData</code> to 1000 to show only the first 1000 lines of output; we don&#39;t want thousands of dots in those tiny plots. The R code given to the <code>ggplot</code> input is added to the plot in R (where it is produced by R&#39;s <code>ggplot</code> function), which is why the yellow trend lines appear on top of the dots.</p>
<p>The other two plots are defined like this:</p>
<pre><code class="listing">PageR {
  .xAxis = random/*[value]
  PlotR {
    .ports = biocontrol[output::*]
    .type = &quot;SobolConvergence&quot;
  }
}
PageR {
  .xAxis = random/*[value]
  PlotR {
    .ports = biocontrol[output::*]
    .type = &quot;SobolIndices&quot;
  }
}
</code></pre>
<p>What sets them apart is their <code>type</code>. These are specialised plots meant to be used only in connection with a sensitivity analysis. For these plots, you will need plenty of iterations to give a correct picture of model sensitivities. Here, we are showing how the plots look after 1,703,936 iterations.</p>
<p>The first plot is a convergence plot:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/biocontrol-sa-2.png"></p>
<p>You use it to judge whether the two Sobol&#39; sensitivity indices (total and first-order) have stabilised, or if you need to increase the number of iterations. The number on the x-axis is the so-called sample size \((N)\) of the analysis. It is \(N=2^n\) defined by the number of iterations = \(2^n(p+2)\) (see <a href='#setting-up-the-analysis'>Setting up the analysis</a>). The first column shows the sums across all 11 parameters for both indices. They are still changing ever so slightly going from \(N=32,768\) to \(N=65,536\) for some of the nine outcome variables (arranged in rows). We judge that \(N=131,072\) is a sufficient sample size for our analysis.</p>
<p>The second plot shows the total and first-order sensitivity indices for each of the nine outcome variables:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/biocontrol-sa-3.png"></p>
<p>The 11 parameters have been sorted for each of the nine outcome variable to show the most influential ones at the top. The error bars show the 95% confidence limits estimated by bootstrapping. You can tell a long story based on this sensitivity analysis. For that we refer to our paper (Saussure et al., submitted 2022).</p>
<h3 id='saving-and-restoring-the-analysis'><li>Saving and restoring the analysis</li></h3>
<p>We already saved the data frame by setting <code>saveDataFrame</code> to <code>TRUE</code> in the <code>OutputR</code> box. Since the bootstrap estimates of the confidence limits on the sensitivity indices can be somewhat time consuming to compute, those estimates are always, automatically, saved as well. This allows you to restore the analysis quickly later on.</p>
<p>The two files are both saved as R data frames written to your <a href='#'>output folder</a>. To find out where that is, use the  <a href='#'>get folders</a> command:</p>
<pre><code class="command">> get folders
</code></pre>
<p>Visit that folder and you will find these two, latest files:</p>
<ul>
<li><em>biocontrol-model-sa_nnnn.Rdata</em></li>
<li><em>biocontrol-model-sa_nnnn-S.Rdata</em></li>

</ul>
<p>where <em>nnnn</em> is some running number. The output folder is not a safe place for files (you should empty it now and then). Copy those two files to another folder for safe-keeping.</p>
<p>You must write your own R script to process the two files but there is an R script to get you started residing in the same folder as the <code>biocontrol-model-sa.box</code> script:</p>
<pre><code class="listing"><a href="https://tildeweb.au.dk/au152367/input/models/aphid/biocontrol-model-sa-restore.R"># biocontrol-model-sa-restore.R&cudarrr;</a>
rm(list=ls(all=TRUE))

# Load standard scripts
source(&quot;&lt;path to your input folder&gt;/scripts/begin.R&quot;)
source(&quot;&lt;path to your input folder&gt;/scripts/begin-sobol.R&quot;)

# Load your data
setwd(&quot;&lt;path to your own folder&gt;&quot;)
load(&quot;biocontrol-model-sa_nnnn.Rdata&quot;)
load(&quot;biocontrol-model-sa_nnnn-S.Rdata&quot;)
</code></pre>
<p>The first line clears R memory just to be certain that we are working on the restored data. The scripts <a href="https://tildeweb.au.dk/au152367/input/scripts/begin.R">begin.R&cudarrr;</a> and <a href="https://tildeweb.au.dk/au152367/input/scripts/begin-sobol.R">begin-sobol.R&cudarrr;</a> are standard scripts with various useful functions found in the <code>scripts</code> sub-folder inside your input folder. Find out where your input folder is by the  <a href='#'>get folders</a> command:</p>
<pre><code class="command">> get folders
</code></pre>
<p>The two calls of <code>load</code> will create the data frames <code>sim</code> and <code>S</code> in R. You can inspect them and find them pretty self-explanatory, except that in the <code>S</code> data frame, we recommend using the bootstrap-estimated confidence limits (<code>LowerPercentile</code> and <code>HigherPercentile</code>) rather than the estimated standard error (<code>EffectSE</code>).</p>
<p>You can treat these data however you want but the final lines in the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/biocontrol-model-sa-restore.R">biocontrol-model-sa-restore.R&cudarrr;</a> script shows you how to re-create the three plots produced by your original <a href="https://tildeweb.au.dk/au152367/input/models/aphid/biocontrol-model-sa.box">biocontrol-model-sa.box&cudarrr;</a> script:</p>
<pre><code class="listing">...
# Prepare analysis
sobol_k = length(unique(S$Input)) - 1
sobol_N = nrow(sim)/(sobol_k+2)
iterationColumn = &quot;iteration&quot;
stepColumn      = &quot;step&quot;

# Plot trends
plot_facetted(
  df   = sim[1:min(nrow(sim),1000),], 
  x    = input_names(), 
  y    = output_names(), 
  ncol = 1, 
  dir  = &#39;h&#39;) + geom_smooth(colour=&#39;yellow&#39;)

# Plot convergence
plot_sobol_convergence()

# Plot indices
ggarrange(
  plotlist=plot_sobol_indices(S)
)
</code></pre>
</div>

<p class='hidden-anchor' id='reproducing-figures-from-saved-data'>xxx</p><p class='hidden-anchor' id='saussure-et-al-submitted'>xxx</p><div class='border-grey'>
<h2>Saussure et al. (submitted)</h2>
<h3><li>Reproducing figures from saved data</li></h3>
<p>Some of the figures below rely on the <code>sim</code> or <code>S</code> data frames, generated by the big (1,703,936 iterations) sensitivity analysis. You can generate those two data frames yourself, using the <code>biocontrol-model-sa.box</code> script with iterations changed to <code>1703936</code> (see <a href='#setting-up-the-analysis'>Setting up the analysis</a>). Just let your computer work it out over a weekend. Alternatively, you can download them (<a href='https://tildeweb.au.dk/au152367/download/aphid-biocontrol-sim.Rdata'>download sim</a> | <a href='https://tildeweb.au.dk/au152367/download/aphid-biocontrol-S.Rdata'>download S</a>). Either way, you will end up with two files with suffix (file type) <code>.Rdata</code> . Put those two files in a folder of your choice.</p>
<p>If an <code>.Rdata</code> file is needed to produce a figure, it will be noted below, together with the name of the R script producing the figure. In that R script, you must change the file path at the top to make it read <em>your</em> <code>.Rdata</code> file. Subsequently run the script in R to generate the figure. As an example, below are the steps to generate <a href='#figure-3'>Figure 3</a>.</p>
<p>First, find the location of the input folder using the  <a href='#'>get folders</a> command:</p>
<pre><code class="command">> get folders
</code></pre>
<p>and open the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/figure-3.R">figure-3.R&cudarrr;</a> script found there (or download it through the provided &cudarrr; link).</p>
<p>You will have to change three variables, all clearly marked at the top of the R script, designating</p>
<ul>
<li>the file name and path of either your <code>sim</code> or <code>S</code> data frame</li>
<li>the name and path leading to the <code>input/scripts/begin.R</code> script, included with your installation of Universal Simulator</li>
<li>the path to the folder where you want the graphics files written (the figures will be shown both on the screen in R and written to files)</li>

</ul>
<p>Here is an example:</p>
<pre><code class="listing"># Load your sim data
sim_data_file = &quot;~/ipm/aphid-biocontrol-sim.Rdata&quot;

# Load standard script
source(&quot;C:/users/joe_cool/UniversalSimulatorHome/input/scripts/begin.R&quot;)

# Output folder
output_folder = &quot;~/ipm/figures&quot;
</code></pre>
Note: The tilde <code>~</code> is a shorthand for your <code>Documents</code> folder. It works even on Windows!</p>
<p>Now save and run the R script.</p>
<h3 id='figure-2'><li>Figure 2</li></h3>
<p>You create this figure by running a script that is nearly identical to the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/biocontrol.box">biocontrol.box&cudarrr;</a> script. Here goes</p>
<pre><code class="command">> run models/aphid/figure-2.box
</code></pre>
<p>The script creates four figures, two on the screen (one in colours, one in grey tones) and two in graphics files (one PNG and one EPS). The <a href="https://tildeweb.au.dk/au152367/input/models/aphid/figure-2.R">figure-2.R&cudarrr;</a> script creates the figures, writing the graphics files to your Universal Simulator output folder; the precise location is reported by the R script, so that you can easily retrieve them. Here is the PNG file:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/fig-2-bw.png" style="width:50%;" /></p>
<p>Since the boxscript contains uncertain parameter values, you will get different results every time you run the script.</p>
<h3 id='figure-3'><li>Figure 3</li></h3>
<p>This figure is generated by the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/figure-3.R">figure-3.R&cudarrr;</a> script. Follow the instructions in <a href='#reproducing-figures-from-saved-data'>Reproducing figures from saved data</a> and watch the result:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/fig-3-bw.png" style="width:50%;" /></p>
<h3 id='figure-4'><li>Figure 4</li></h3>
<p>This figure is generated by the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/figure-4.R">figure-4.R&cudarrr;</a> script. Follow the instructions in <a href='#reproducing-figures-from-saved-data'>Reproducing figures from saved data</a> and watch the result:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/fig-4-bw.png" style="width:50%;" /></p>
<h3 id='figure-5'><li>Figure 5</li></h3>
<p>This figure is generated by the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/figure-5.R">figure-5.R&cudarrr;</a> script. Follow the instructions in <a href='#reproducing-figures-from-saved-data'>Reproducing figures from saved data</a> and watch the result:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/fig-5-bw.png" style="width:50%;" /></p>
<p>Hey, wait. That didn&#39;t quite work out like that. The figure you generated is missing all the labels. That&#39;s because we handicrafted them afterwards, as we found it impossible to get these nice-looking labels in R. For proper labelling, you will find a text file with all figure data in <a href="https://tildeweb.au.dk/au152367/input/models/aphid/fig-5-bw-table.txt">fig-5-bw-table.txt&cudarrr;</a>, which was written to the output_folder by the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/figure-5.R">figure-5.R&cudarrr;</a> script.</p>
<p>The figure depicts Sobol‚Äô indices \((S_{Ti}\): dark grey; \(S_i\) : light grey\()\) showing model sensitivity to the nine uncertain model parameters, in terms of three model outcomes: (a) peak prevalence of exposed aphids, (b) peak prevalence of cadavers, and (c) yield improvement due to biocontrol. The model parameters are listed in order of importance for each outcome according to \(S_{Ti}\).</p>
<h3 id='figure-6'><li>Figure 6</li></h3>
<p>This figure is generated by the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/figure-6.R">figure-6.R&cudarrr;</a> script. You need to have the <code>mgcv</code> package installed in R before you run the script. Otherwise,  follow the instructions in <a href='#reproducing-figures-from-saved-data'>Reproducing figures from saved data</a> and watch the result:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/fig-6-bw.png" style="width:90%;" /></p>
<p>If you study the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/figure-6.R">figure-6.R&cudarrr;</a> script, you will find that many a trick was pulled to produce this figure! The mathematical symbols were added afterwards outside R. </p>
<p>The figure depicts the response of three model outcomes to variation in the seven most influential model parameters (excluding weather). </p>
<h3 id='figure-7'><li>Figure 7</li></h3>
<p>This figure is generated by the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/figure-7.R">figure-7.R&cudarrr;</a> script. Follow the instructions in <a href='#reproducing-figures-from-saved-data'>Reproducing figures from saved data</a> and watch the result:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/fig-7-bw.png" style="width:50%;" /></p>
<h3 id='figure-8'><li>Figure 8</li></h3>
<p>This figure is generated by the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/figure-8.R">figure-8.R&cudarrr;</a> script. Follow the instructions in <a href='#reproducing-figures-from-saved-data'>Reproducing figures from saved data</a> and watch the result:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/fig-8-colour.png" style="width:80%;" /></p>
<h3 id='figure-9'><li>Figure 9</li></h3>
<p>This figure is generated by the <a href="https://tildeweb.au.dk/au152367/input/models/aphid/figure-9.R">figure-9.R&cudarrr;</a> script. Follow the instructions in <a href='#reproducing-figures-from-saved-data'>Reproducing figures from saved data</a> and watch the result:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/fig-9-colour.png" style="width:90%;" /></p>
<h3 id='figure-10'><li>Figure 10</li></h3>
<p>You create this figure by running the boxscript,</p>
<pre><code class="command">> run models/aphid/figure-10.box
</code></pre>
<p>to get the result:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/fig-10-colour.png" style="width:90%;" /></p>
<h3 id='figure-11'><li>Figure 11</li></h3>
<p>You create this figure by running the boxscript,</p>
<pre><code class="command">> run models/aphid/figure-11.box
</code></pre>
<p>to get the result:</p>
<p><img src="https://tildeweb.au.dk/au152367/media/models/aphid/fig-11-colour.png" style="width:90%;" /></p></div>

<p class='hidden-anchor' id='overview'>xxx</p><div class='border-grey'>
</div>
        
      </div>
      <div class="end-index-headers"></div>
      
      <div class="left">
        <div class="begin-menu"></div>
<ul class="border-grey"><a href="#"><img class="squirrel-link" src="media/squirrel.gif"/ title="Go to top of page"></a><li><a href="#overview">Overview</a></li><li><a href="#cereal-aphid-fungus-model">Cereal aphid-fungus model</a><ul><li><a href="#background">Background</a></li><li><a href="#crop-model">Crop model</a></li><li><a href="#crop-aphid-model">Crop-aphid model</a></li><li><a href="#crop-aphid-model-with-uncertainty">Crop-aphid model with uncertainty</a></li><li><a href="#crop-aphid-fungus-model">Crop-aphid-fungus model</a></li><li><a href="#biocontrol-model-with-uncertainty-analysis">Biocontrol model with uncertainty analysis</a></li><li><a href="#biocontrol-with-sensitivity-analysis">Biocontrol with sensitivity analysis</a></li><li><a href="#saussure-et-al-submitted">Saussure et al. (submitted)</a>
        <div class="end-menu"></div>
      </div>
      <div class="end macro"></div>
      <div class="insert macro">#right.html</div>
      <div class="begin macro"></div>
      <div class="right">
        <div class="border-red">
          <h2>Try it!</h2>
          <p>Download the latest version with the newly published Cereal Aphid-Fungus model. Also includes the Virtual Greenhouse model. </p>
          <p class="date">2 Aug 2023</p>
        </div>
        <div class="border-orange">
          <h2>Contact</h2>
          <p>Any questions concerning our models and tools? Interested in visiting the lab? Want to chat online? <a href="mailto:niels.holst@agro.au.dk">Write us</a>.</p>
          <p class="date">2 Aug 2023</p>
        </div>
        <div class="border-violet">
          <h2>Model just published</h2>
          <p>Read our paper on the Cereal Aphid-Fungus model and study the detailed documentation. Any questions? Write us.</p>
          <p class="date">2 Aug 2023</p>
        </div>
        <div class="border-pink">
          <h2>Home page overhaul</h2>
          <p>We remain candy-coloured until further notice. Barbie goes from model to modeller!</p>
          <p class="date">1 Aug 2023</p>
        </div>
      </div>
      <div class="end macro"></div>
    </div>
    <div class="insert macro">#footer.html</div>
    <div class="begin macro"></div>
    <div id="footer" class="border-brown">
      <p>The Ecological Modelling Laboratory is the lab of</p>
      <p>Senior Scientist Niels Holst, Dept. of Agroecology, Aarhus University, Denmark</p>
    </div>
    <div class="end macro"></div>
  </body>
</html>
